<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>The Decision — Systems + Cutscene Layer</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0e0f12; color:#eaeaea; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 18px; }
    .top { display:flex; gap:12px; flex-wrap:wrap; align-items:stretch; }
    .card { background:#151820; border:1px solid #242a36; border-radius: 16px; padding: 14px; }
    .hud { flex: 1 1 420px; }
    .meta { flex: 1 1 240px; display:flex; flex-direction:column; gap:10px; }
    .row { display:grid; grid-template-columns: 130px 1fr 60px; gap:10px; align-items:center; margin: 8px 0; }
    .meter { height: 14px; background:#0b0d12; border:1px solid #2a3242; border-radius: 999px; overflow:hidden; }
    .meter > div { height:100%; width:50%; background:#eaeaea; }
    .muted { color:#aab2c5; font-size: 0.95rem; }
    .screen { margin-top: 12px; }
    h2 { margin: 0 0 8px 0; font-size: 1.25rem; }
    h3 { margin: 14px 0 6px; font-size: 1.05rem; }
    p { margin: 8px 0; line-height: 1.55; }
    .btns { display:flex; flex-wrap:wrap; gap:10px; margin-top: 12px; }
    button { background:#eaeaea; color:#0e0f12; border:0; border-radius: 12px; padding: 10px 12px; cursor:pointer; font-weight: 700; }
    button.secondary { background: transparent; color:#eaeaea; border:1px solid #3a445a; font-weight: 700; }
    button:disabled { opacity: 0.45; cursor:not-allowed; }
    .pill { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid #2a3242; border-radius: 999px; }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 720px) { .grid2 { grid-template-columns: 1fr; } }
    .log { max-height: 180px; overflow:auto; padding:10px; background:#0b0d12; border:1px solid #2a3242; border-radius: 12px; }
    .log div { margin: 6px 0; }
    hr { border:0; border-top:1px solid #242a36; margin: 14px 0; }
    .tag { display:inline-block; padding: 2px 8px; border-radius: 999px; border:1px solid #2a3242; color:#cbd3e8; font-size:0.85rem; }
    .warn { color:#ffd27a; }
    .bad { color:#ff9aa2; }
    .good { color:#b4ffbf; }

    /* Cutscene / pacing */
    .typebox { background:#0b0d12; border:1px solid #2a3242; border-radius: 12px; padding: 14px; min-height: 120px; }
    .speaker { font-weight: 800; letter-spacing: .2px; margin-bottom: 6px; }
    .cursor { display:inline-block; width:10px; opacity:.7; animation: blink 1s steps(1) infinite; }
    @keyframes blink { 50% { opacity: 0; } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="hud card">
        <div class="row"><div>Money</div><div class="meter"><div id="mMoney"></div></div><div id="vMoney">0</div></div>
        <div class="row"><div>Relationship</div><div class="meter"><div id="mRel"></div></div><div id="vRel">0</div></div>
        <div class="row"><div>Pressure</div><div class="meter"><div id="mPress"></div></div><div id="vPress">0</div></div>
        <div class="row"><div>Stress</div><div class="meter"><div id="mStress"></div></div><div id="vStress">0</div></div>
        <div class="row"><div>Cat Safety</div><div class="meter"><div id="mCats"></div></div><div id="vCats">0</div></div>
        <div class="muted">Now with a “fake backend API” layer + cutscene pacing + stress relief choices.</div>
      </div>

      <div class="meta card">
        <div class="pill"><strong>Day</strong> <span id="dayLabel">1</span> / 7</div>
        <div class="pill"><strong>Decisions Left</strong> <span id="apLabel">3</span></div>
        <div class="pill"><strong>Status</strong> <span id="statusLabel" class="muted">Stable</span></div>
        <div>
          <div class="muted" style="margin-bottom:6px;">Run Log</div>
          <div id="log" class="log"></div>
        </div>
      </div>
    </div>

    <div id="screen" class="screen card"></div>
  </div>

<script>
/* ---------------------------
   THE DECISION — SYSTEMS + CUTSCENE LAYER
   - "API" separation (simulated backend with async calls + delay)
   - Landlord intro cutscene + daily pestering
   - Decisions staggered across morning/afternoon/evening
   - Stress relief action (bar / walk), with tradeoffs
---------------------------- */

const MAX_DAYS = 7;

/* ---------------------------
   "BACKEND" STATE (server-side-ish)
---------------------------- */
const state = {
  // time
  day: 1,
  slot: 0,            // 0=morning,1=afternoon,2=evening
  ap: 3,

  // meters (0-100)
  money: 55,
  rel: 62,
  press: 10,
  stress: 18,
  cats: 65,

  // flags / history
  didNegotiate: false,
  didTalk: 0,
  didOvertime: 0,
  didHide: 0,
  didFriend: false,
  didShelter: false,
  didMovePlan: 0,
  drank: 0,
  walked: 0,

  lied: 0,
  truth: 0,

  // outcomes
  catOutcome: null,
  ending: null,

  // run log
  log: [],

  // gating (simple lock to prevent double-clicking during cutscenes)
  locked: false
};

function clamp(v){ return Math.max(0, Math.min(100, v)); }
function clamp01(v){ return Math.max(0, Math.min(1, v)); }
function rint(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
function chance(p){ return Math.random() < p; }

const SLOT_LABELS = ["Morning", "Afternoon", "Evening"];

/* ---------------------------
   FAKE API LAYER (simulates backend calls)
   - returns Promises
   - introduces tiny delay so UI feels like a system responding
---------------------------- */
const api = {
  async act(actionName){
    await wait(220);             // "network"
    applyAction(actionName);     // server logic
    await wait(120);
    return getSnapshot();
  },
  async endSlot(){
    await wait(240);
    advanceSlot();
    await wait(120);
    return getSnapshot();
  },
  async endDay(){
    await wait(260);
    endOfDayDrift();
    await wait(160);
    return getSnapshot();
  },
  async rollDailyEvent(){
    await wait(240);
    runDailyEvent();
    await wait(160);
    return getSnapshot();
  }
};

function getSnapshot(){
  // in a real API this would return a copy; keep it simple:
  return JSON.parse(JSON.stringify(state));
}
function wait(ms){ return new Promise(res => setTimeout(res, ms)); }

/* ---------------------------
   UI HELPERS
---------------------------- */

function addLog(msg){
  state.log.unshift(`Day ${state.day} (${SLOT_LABELS[state.slot]}): ${msg}`);
  if(state.log.length > 40) state.log.pop();
  renderHud();
}
function meterStatus(){
  if(state.press >= 85) return "Critical";
  if(state.press >= 60) return "Rising";
  return "Stable";
}
function escapeHtml(s){
  return s.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}
function renderHud(){
  const map = [
    ["money","mMoney","vMoney"],
    ["rel","mRel","vRel"],
    ["press","mPress","vPress"],
    ["stress","mStress","vStress"],
    ["cats","mCats","vCats"],
  ];
  for(const [k,bar,val] of map){
    const v = clamp(state[k]);
    document.getElementById(bar).style.width = v + "%";
    document.getElementById(val).textContent = v;
  }
  document.getElementById("dayLabel").textContent = state.day;
  document.getElementById("apLabel").textContent = state.ap;
  document.getElementById("statusLabel").textContent = meterStatus();

  const logEl = document.getElementById("log");
  logEl.innerHTML = state.log.map(x => `<div>• ${escapeHtml(x)}</div>`).join("");
}
function setScreen(html){
  document.getElementById("screen").innerHTML = html;
  renderHud();
}

function lockUI(on){
  state.locked = on;
  // Disable all buttons on screen when locked
  document.querySelectorAll("#screen button").forEach(b => b.disabled = on || b.disabled);
}

/* ---------------------------
   CUTSCENE / TEXT ANIMATION
---------------------------- */
async function cutscene({title, lines, onDoneLabel="Continue", onDone}){
  // lines: [{speaker, text, pauseAfterMs?}, ...]
  setScreen(`
    <h2>${escapeHtml(title)}</h2>
    <div class="typebox" id="typebox"></div>
    <div class="btns">
      <button id="nextBtn" disabled>${escapeHtml(onDoneLabel)}</button>
    </div>
  `);

  const box = document.getElementById("typebox");
  const btn = document.getElementById("nextBtn");

  lockUI(true);

  for(const line of lines){
    const speaker = line.speaker ? `<div class="speaker">${escapeHtml(line.speaker)}</div>` : "";
    const p = document.createElement("div");
    p.style.marginBottom = "14px";
    p.innerHTML = `${speaker}<div><span class="txt"></span><span class="cursor">▍</span></div>`;
    box.appendChild(p);

    const span = p.querySelector(".txt");
    await typeText(span, line.text, 14);

    // dramatic pause / "but..."
    if(line.pauseAfterMs) await wait(line.pauseAfterMs);
  }

  lockUI(false);
  btn.disabled = false;
  btn.onclick = () => onDone && onDone();
}

async function typeText(el, text, cps){
  // cps = ms per char-ish (lower is faster)
  for(let i=0;i<text.length;i++){
    el.textContent += text[i];
    // tiny variation for rhythm
    const ch = text[i];
    let delay = cps;
    if(ch === "," ) delay = 90;
    if(ch === "." ) delay = 160;
    if(ch === "…" ) delay = 220;
    if(ch === "\n") delay = 50;
    await wait(delay);
  }
}

/* ---------------------------
   GAME FLOW
---------------------------- */

function intro(){
  setScreen(`
    <h2>The Decision (Systems + Story Layer)</h2>
    <p>You’re managing a week-long pressure cooker. The “dashboard” is the system underneath; the story is how it hits you throughout the day.</p>
    <p class="muted">Three decisions per day, staggered across morning/afternoon/evening. Expect interruptions.</p>
    <div class="btns">
      <button onclick="startGame()">Start</button>
      <button class="secondary" onclick="howTo()">How this works</button>
    </div>
  `);
}

function howTo(){
  setScreen(`
    <h2>How it Works</h2>
    <div class="grid2">
      <div class="card">
        <h3>“Backend API” feel</h3>
        <p class="muted">Actions go through a simulated API. The game responds with delays + log feedback, like a system pushing back.</p>
      </div>
      <div class="card">
        <h3>Staggered decisions</h3>
        <p class="muted">You don’t pick all 3 actions at once. Each time-slot gets one decision and a moment/cutscene.</p>
      </div>
    </div>
    <div class="btns">
      <button onclick="intro()">Back</button>
      <button class="secondary" onclick="startGame()">Play</button>
    </div>
  `);
}

async function startGame(){
  resetRun(true);
  addLog("Prototype loaded.");
  await landlordIntroCutscene();
}

async function landlordIntroCutscene(){
  await cutscene({
    title: "Cutscene: The Landlord",
    lines: [
      {speaker:"Landlord", text:"We need to talk.", pauseAfterMs: 500},
      {speaker:"Landlord", text:"The lease says no pets. Neighbors complained.", pauseAfterMs: 700},
      {speaker:"Landlord", text:"You have one week to remove the cats…", pauseAfterMs: 900},
      {speaker:"Landlord", text:"…or I start the process.", pauseAfterMs: 1200},
    ],
    onDoneLabel: "Start Day 1",
    onDone: () => dayStartCutscene()
  });
}

async function dayStartCutscene(){
  // Daily pestering scales with pressure.
  const pest = landlordMessageForDay();
  await cutscene({
    title: `Day ${state.day}: ${SLOT_LABELS[state.slot]}`,
    lines: [
      {speaker:"You", text:"You wake up already counting days.", pauseAfterMs: 600},
      {speaker:"Phone", text:pest, pauseAfterMs: 900},
      {speaker:"You", text:"You have to decide what to do…", pauseAfterMs: 600},
      {speaker:"You", text:"…but…", pauseAfterMs: 900},
    ],
    onDoneLabel: "Make your first decision",
    onDone: () => slotHub()
  });
}

function landlordMessageForDay(){
  const base = [
    "Reminder: pets must be removed by the end of the week.",
    "I’m checking in. We can’t ignore this.",
    "I need an update today.",
    "This can get formal if it has to.",
  ];
  let msg = base[Math.min(base.length-1, Math.floor(state.day/2))];

  if(state.press >= 70) msg = "I’m hearing more complaints. I’ll be by soon.";
  if(state.press >= 85) msg = "Final warning: I’m scheduling an inspection.";
  return msg;
}

/* ---------------------------
   STAGGERED HUB (one decision per slot)
---------------------------- */

function slotHub(){
  if(state.locked) return;

  // If already resolved cat outcome, go to aftermath
  if(state.catOutcome) return aftermathHub();

  // forced reveal conditions
  if(state.press >= 100 || state.cats <= 10) return revealEvent("system_forced");

  const warn = (state.press >= 70) ? `<span class="tag warn">Pressure is high</span>` : `<span class="tag">You have time</span>`;
  const relTag = (state.rel <= 30) ? `<span class="tag bad">Relationship fragile</span>` : `<span class="tag">Relationship ok</span>`;
  const catTag = (state.cats <= 35) ? `<span class="tag warn">Cats at risk</span>` : `<span class="tag">Cats stable</span>`;
  const stressTag = (state.stress >= 70) ? `<span class="tag warn">Stress high</span>` : `<span class="tag">Stress manageable</span>`;

  setScreen(`
    <h2>Day ${state.day} — ${SLOT_LABELS[state.slot]}</h2>
    <p class="muted">One decision now. The day continues whether you feel ready or not.</p>
    <div class="btns">${warn}${relTag}${catTag}${stressTag}</div>

    <hr>

    <h3>Family / Trust</h3>
    <div class="btns">
      <button ${state.ap<=0?"disabled":""} onclick="doAction('talk')">Talk with your kid (honest)</button>
      <button ${state.ap<=0?"disabled":""} onclick="doAction('quality')">Quality time (small moment)</button>
      <button ${state.ap<=0?"disabled":""} onclick="doAction('distance')">Avoid / stay cold</button>
    </div>

    <h3>Money / Stability</h3>
    <div class="btns">
      <button ${state.ap<=0?"disabled":""} onclick="doAction('overtime')">Work overtime</button>
      <button ${state.ap<=0?"disabled":""} onclick="doAction('cut')">Cut costs (kid sacrifice)</button>
      <button ${state.ap<=0?"disabled":""} onclick="doAction('move')">Search for new place</button>
    </div>

    <h3>Cat Problem</h3>
    <div class="btns">
      <button ${state.ap<=0?"disabled":""} onclick="doAction('negotiate')">Negotiate accommodations</button>
      <button ${state.ap<=0?"disabled":""} onclick="doAction('hide')">Hide cats temporarily</button>
      <button ${state.ap<=0?"disabled":""} onclick="doAction('friend')">Ask a friend to rehome</button>
      <button ${state.ap<=0?"disabled":""} onclick="doAction('shelter')">Contact a shelter</button>
    </div>

    <h3>Stress Relief</h3>
    <p class="muted">You asked for a way to lower stress. These help… but they cost something.</p>
    <div class="btns">
      <button ${state.ap<=0?"disabled":""} onclick="doAction('walk')">Walk the block (clear your head)</button>
      <button ${state.ap<=0?"disabled":""} onclick="doAction('bar')">Go to the bar (one drink)</button>
    </div>

    <hr>
    <div class="btns">
      <button class="secondary" onclick="endSlotFlow()">Skip this slot</button>
    </div>
  `);
}

async function doAction(actionName){
  if(state.locked || state.ap <= 0) return;
  state.locked = true;

  // quick story beat before the system responds
  await actionBeat(actionName);

  // "API" call that applies the action
  await api.act(actionName);

  state.locked = false;
  // after a decision, move time forward automatically
  await endSlotFlow(true);
}

async function actionBeat(actionName){
  const beats = {
    talk: [
      {speaker:"You", text:"You sit down with your kid.", pauseAfterMs: 400},
      {speaker:"You", text:"You try to say it plainly…", pauseAfterMs: 700},
      {speaker:"You", text:"…but…", pauseAfterMs: 700},
    ],
    quality: [
      {speaker:"Kid", text:"Can we watch something? Just… us?", pauseAfterMs: 500},
      {speaker:"You", text:"You say yes before your brain can argue.", pauseAfterMs: 600},
    ],
    distance: [
      {speaker:"Kid", text:"Are you mad at me?", pauseAfterMs: 500},
      {speaker:"You", text:"You pretend you didn’t hear.", pauseAfterMs: 700},
    ],
    overtime: [
      {speaker:"Phone", text:"Extra shift available.", pauseAfterMs: 450},
      {speaker:"You", text:"You accept. Your chest tightens anyway.", pauseAfterMs: 600},
    ],
    cut: [
      {speaker:"You", text:"You open the budget and start cutting.", pauseAfterMs: 500},
      {speaker:"You", text:"It feels like asking your kid to shrink.", pauseAfterMs: 700},
    ],
    move: [
      {speaker:"You", text:"Listings. Deposits. Commutes. Dead ends.", pauseAfterMs: 650},
      {speaker:"You", text:"Still… a path.", pauseAfterMs: 450},
    ],
    negotiate: [
      {speaker:"You", text:"You rehearse the wording, then call.", pauseAfterMs: 600},
      {speaker:"You", text:"You keep your voice steady…", pauseAfterMs: 700},
    ],
    hide: [
      {speaker:"You", text:"You move the carrier, the bowls, the litter.", pauseAfterMs: 600},
      {speaker:"You", text:"It works.", pauseAfterMs: 500},
      {speaker:"You", text:"For now.", pauseAfterMs: 900},
    ],
    friend: [
      {speaker:"You", text:"You type the text. Delete it. Type again.", pauseAfterMs: 700},
      {speaker:"You", text:"Finally: send.", pauseAfterMs: 500},
    ],
    shelter: [
      {speaker:"You", text:"You scroll shelter listings with a shaking thumb.", pauseAfterMs: 700},
      {speaker:"You", text:"You tell yourself it’s for safety.", pauseAfterMs: 700},
    ],
    walk: [
      {speaker:"You", text:"Cold air. A longer exhale than you expected.", pauseAfterMs: 700},
      {speaker:"You", text:"Your thoughts get quieter.", pauseAfterMs: 500},
    ],
    bar: [
      {speaker:"Bartender", text:"Rough day?", pauseAfterMs: 600},
      {speaker:"You", text:"You nod. The glass is colder than your hands.", pauseAfterMs: 700},
    ],
  };

  await cutscene({
    title: "Moment",
    lines: beats[actionName] || [{speaker:"", text:"Time passes.", pauseAfterMs: 500}],
    onDoneLabel: "Let the system respond",
    onDone: () => {}
  });

  // If you hit Continue, we return to doAction which then applies the action.
}

/* ---------------------------
   ACTION APPLICATION (server logic)
---------------------------- */

function useAP(){
  state.ap = Math.max(0, state.ap - 1);
  // baseline stress creep per decision (lower than before, since you asked for relief options)
  state.stress = clamp(state.stress + 2);
  // pressure creeps a bit as time passes
  state.press = clamp(state.press + 1);
}

function applyAction(a){
  useAP();

  if(a === "talk"){
    state.didTalk++;
    state.rel = clamp(state.rel + 10);
    state.press = clamp(state.press - 6);
    state.stress = clamp(state.stress + 1);
    addLog("You told your kid the truth (some of it). Trust improves; pressure eases.");
    return;
  }

  if(a === "quality"){
    // FIX: quality time should be a small relief, not only increasing stress
    state.rel = clamp(state.rel + 7);
    state.money = clamp(state.money - 3);
    state.stress = clamp(state.stress - 4); // relief
    state.press = clamp(state.press + 1);
    addLog("A quiet, heartfelt moment. Relationship rises; stress drops a bit.");
    return;
  }

  if(a === "distance"){
    state.rel = clamp(state.rel - 8);
    state.press = clamp(state.press + 7);
    addLog("You stayed distant. Relationship weakens; pressure grows.");
    return;
  }

  if(a === "overtime"){
    state.didOvertime++;
    state.money = clamp(state.money + rint(8,14));
    state.rel = clamp(state.rel - 4);
    state.stress = clamp(state.stress + 10);
    addLog("Overtime boosts money, but drains you and costs time with your kid.");
    return;
  }

  if(a === "cut"){
    const relHit = (state.didTalk > 0) ? 4 : 12;
    state.money = clamp(state.money + rint(10,16));
    state.rel = clamp(state.rel - relHit);
    state.press = clamp(state.press - 2);
    addLog(`You cut costs. Money improves; relationship takes a hit (-${relHit}).`);
    return;
  }

  if(a === "move"){
    state.didMovePlan++;
    state.money = clamp(state.money - 6);
    state.press = clamp(state.press - 7);
    state.stress = clamp(state.stress + 3);
    addLog("You searched for housing. Costs time/money, reduces pressure.");
    return;
  }

  if(a === "negotiate"){
    state.didNegotiate = true;
    const success = chance(0.25 + (state.money/420) - (state.stress/520));
    if(success){
      state.press = clamp(state.press - 16);
      state.cats = clamp(state.cats + 10);
      state.stress = clamp(state.stress - 2);
      addLog("Negotiation succeeds: temporary accommodation reduces risk.");
    } else {
      state.press = clamp(state.press + 10);
      state.stress = clamp(state.stress + 6);
      addLog("Negotiation fails. The system pushes back; pressure rises.");
    }
    return;
  }

  if(a === "hide"){
    state.didHide++;
    state.cats = clamp(state.cats + 8);
    state.press = clamp(state.press + 10);
    addLog("You hid the cats. It works—for now. Pressure rises from avoidance.");
    return;
  }

  if(a === "friend"){
    const success = chance(0.30 + (state.rel/300) - (state.press/420));
    if(success){
      state.didFriend = true;
      state.cats = clamp(state.cats + 25);
      state.press = clamp(state.press - 8);
      addLog("A friend may take the cats temporarily. Cat safety improves.");
    } else {
      state.cats = clamp(state.cats - 10);
      state.stress = clamp(state.stress + 6);
      addLog("Your friend can’t help. Cat safety drops; stress rises.");
    }
    return;
  }

  if(a === "shelter"){
    state.didShelter = true;
    state.cats = clamp(state.cats + 18);
    state.rel = clamp(state.rel - 6);
    state.press = clamp(state.press - 6);
    addLog("You contacted a shelter. It’s safer, but emotionally heavy.");
    return;
  }

  // NEW: stress relief actions
  if(a === "walk"){
    state.walked++;
    state.stress = clamp(state.stress - rint(10,16));
    state.press = clamp(state.press - 2);
    state.money = clamp(state.money - 1);
    addLog("You walked. Stress drops. You return slightly steadier.");
    return;
  }

  if(a === "bar"){
    state.drank++;
    // short-term relief, long-term tradeoff
    state.stress = clamp(state.stress - rint(14,22));
    state.money = clamp(state.money - rint(4,8));
    state.rel = clamp(state.rel - 2);
    // a little pressure rebound later because avoidance
    state.press = clamp(state.press + 2);
    addLog("One drink takes the edge off. Money drops; connection costs a little.");
    return;
  }
}

/* ---------------------------
   TIME ADVANCE: slots + daily pestering/events
---------------------------- */

async function endSlotFlow(fromAction=false){
  if(state.locked) return;
  state.locked = true;

  // If player skips a slot, it should hurt a bit (you didn't act)
  if(!fromAction){
    state.stress = clamp(state.stress + 3);
    state.press = clamp(state.press + 4);
    state.cats = clamp(state.cats - rint(1,3));
    addLog("You hesitated. Time passes anyway.");
    state.ap = Math.max(0, state.ap - 1); // skipping costs a decision
  }

  await api.endSlot(); // advances slot

  // If we completed all 3 slots, roll end-of-day drift + one event + landlord pestering
  if(state.slot === 0){ // wrapped to morning means new day started
    await api.endDay();
    await api.rollDailyEvent();

    // Force resolution check after event + drift
    if(state.press >= 100 || state.day > MAX_DAYS || state.cats <= 10){
      state.locked = false;
      return revealEvent("deadline_or_collapse");
    }

    // Start next day cutscene
    state.locked = false;
    return dayStartCutscene();
  }

  state.locked = false;
  slotHub();
}

function advanceSlot(){
  // move morning->afternoon->evening->(wrap)
  state.slot++;
  if(state.slot > 2){
    state.slot = 0;
  }
}

function endOfDayDrift(){
  // daily drift scaled by how many decisions were actually used (staggered)
  // If player ended early / skipped decisions, pressure rises more.
  const used = 3 - state.ap;
  const unused = 3 - used;

  // baseline drift
  state.press = clamp(state.press + 10 + (unused * 4));
  state.money = clamp(state.money - rint(4,8));
  state.cats = clamp(state.cats - rint(2,6));
  state.stress = clamp(state.stress + rint(2,5) + (unused * 2));

  // landlord pestering increases pressure if already high
  if(state.press >= 70){
    state.press = clamp(state.press + 4);
    addLog("The landlord keeps pestering. Pressure inches up.");
  } else {
    addLog("Another day ends. The deadline feels closer.");
  }

  // advance day + reset decisions
  state.day++;
  state.ap = 3;
}

function runDailyEvent(){
  // weighted event selection (acts like “system output”)
  const events = [];

  const inspP = 0.10 + (state.press/250) + ((50 - state.cats)/320);
  events.push({name:"inspection", p: clamp01(inspP)});

  const feeP = 0.10 + ((50 - state.money)/320);
  events.push({name:"fee", p: clamp01(feeP)});

  const workP = 0.12 + (state.press/420);
  events.push({name:"work", p: clamp01(workP)});

  const hearP = 0.08 + ((40 - state.rel)/320);
  events.push({name:"overhear", p: clamp01(hearP)});

  const pick = weightedPick(events);
  applyEvent(pick);
}

function weightedPick(list){
  const total = list.reduce((a,x)=>a+x.p,0);
  let roll = Math.random()*total;
  for(const item of list){
    roll -= item.p;
    if(roll <= 0) return item.name;
  }
  return list[list.length-1].name;
}

function applyEvent(name){
  if(name === "inspection"){
    const caught = chance(0.22 + (state.press/280) - (state.didNegotiate?0.12:0));
    if(caught){
      state.press = clamp(state.press + 18);
      state.cats = clamp(state.cats - 20);
      addLog("A surprise inspection spikes risk. The system closes in.");
    } else {
      state.press = clamp(state.press + 6);
      addLog("Rumors of an inspection raise pressure, but nothing happens today.");
    }
  }
  if(name === "fee"){
    const fee = rint(8,18);
    state.money = clamp(state.money - fee);
    state.stress = clamp(state.stress + 6);
    addLog(`A surprise expense hits (-${fee} money).`);
  }
  if(name === "work"){
    const gain = rint(6,12);
    state.money = clamp(state.money + gain);
    state.rel = clamp(state.rel - 4);
    state.stress = clamp(state.stress + 5);
    addLog(`Extra hours appear (+${gain} money), but it costs family time.`);
  }
  if(name === "overhear"){
    const hit = (state.didHide || state.didShelter) ? 12 : 6;
    state.rel = clamp(state.rel - hit);
    addLog(`Your kid overhears something. Relationship drops (-${hit}).`);
  }
}

/* ---------------------------
   REVEAL EVENT (Delayed payoff)
---------------------------- */

function revealEvent(reason){
  let outcome = null;

  // Make cats meter matter more directly:
  // If cats are relatively safe, "system_removed" becomes less likely.
  const catsSafeBias = (state.cats >= 60) ? 0.18 : 0;

  if(state.didMovePlan >= 3 && state.money >= 35){
    outcome = "moved_with_cats";
  } else if(state.didFriend && chance(0.70)){
    outcome = "friend";
  } else if(state.didShelter && chance(0.82)){
    outcome = "shelter";
  } else if(state.didHide > 0){
    outcome = chance(0.55) ? "cats_gone_unsure" : "system_removed";
  } else {
    outcome = chance(0.62 - catsSafeBias) ? "system_removed" : "cats_gone_unsure";
  }

  state.catOutcome = outcome;

  if(outcome === "moved_with_cats"){
    state.money = clamp(state.money - rint(10,20));
    state.press = clamp(state.press - 30);
    state.stress = clamp(state.stress + 8);
    addLog("You moved. Money drops, pressure eases. The cats remain with you.");
  }
  if(outcome === "friend"){
    state.press = clamp(state.press - 18);
    state.cats = 90;
    addLog("The cats are with a friend for now. The immediate risk decreases.");
  }
  if(outcome === "shelter"){
    state.rel = clamp(state.rel - 8);
    state.press = clamp(state.press - 12);
    addLog("The shelter takes the cats. It’s safer… and heavier.");
  }
  if(outcome === "system_removed"){
    state.rel = clamp(state.rel - 18);
    // less “teleport to 100” — feels more earned, still devastating
    state.press = clamp(Math.max(state.press, 85) + 10);
    addLog("The system intervenes. The cats are gone. You lost control of the timeline.");
  }
  if(outcome === "cats_gone_unsure"){
    state.rel = clamp(state.rel - 10);
    state.press = clamp(Math.max(state.press, 80) + 8);
    addLog("A cat disappears. You know more than you’re ready to say.");
  }

  let revealText = "";
  if(outcome === "moved_with_cats") revealText = "You secured a new place. Rent is higher, but the cats are still here.";
  if(outcome === "friend") revealText = "The cats aren’t home. They’re safe with someone else… for now.";
  if(outcome === "shelter") revealText = "The cats aren’t home. You made arrangements. Your kid can tell something changed.";
  if(outcome === "system_removed") revealText = "The cats are gone. It happened fast. You can’t pretend the system didn’t do this.";
  if(outcome === "cats_gone_unsure") revealText = "A cat is gone. The cause is unclear—unless you decide to explain it.";

  setScreen(`
    <h2>Delayed Moral Payoff</h2>
    <p>${escapeHtml(revealText)}</p>
    <p class="muted">Next: do you tell the truth, lie, or stay silent?</p>
    <div class="btns">
      <button onclick="truthLie()">Continue</button>
    </div>
  `);
}

function truthLie(){
  const outcome = state.catOutcome;
  const canBlameSystem = (outcome === "system_removed" || outcome === "cats_gone_unsure");
  const canHalfTruth = (outcome === "friend" || outcome === "shelter" || outcome === "cats_gone_unsure");

  setScreen(`
    <h2>What do you tell your kid?</h2>
    <p class="muted">Your choice changes relationship now — and future custody stability later.</p>
    <div class="btns">
      <button onclick="chooseTruth()">Tell the truth</button>
      <button ${canHalfTruth?"":"disabled"} onclick="chooseHalfTruth()">Partial truth</button>
      <button ${canBlameSystem?"":"disabled"} onclick="chooseLie()">Lie and blame the system</button>
      <button class="secondary" onclick="chooseSilent()">Say nothing</button>
    </div>
  `);
}

function chooseTruth(){
  state.truth++;
  let delta = (state.didTalk > 0) ? 10 : 2;
  if(state.catOutcome === "shelter") delta -= 4;
  if(state.catOutcome === "system_removed") delta -= 6;
  state.rel = clamp(state.rel + delta);
  state.stress = clamp(state.stress + 3);
  addLog(`You told the truth. Relationship change: ${delta>=0?"+":""}${delta}.`);
  // move to aftermath (remaining days)
  state.slot = 0;
  state.ap = 3;
  aftermathStart();
}

function chooseHalfTruth(){
  let delta = 3;
  if(state.didTalk === 0) delta = -2;
  state.rel = clamp(state.rel + delta);
  state.press = clamp(state.press + 4);
  state.stress = clamp(state.stress + 2);
  addLog(`You gave a partial truth. Relationship change: ${delta>=0?"+":""}${delta}.`);
  state.slot = 0;
  state.ap = 3;
  aftermathStart();
}

function chooseLie(){
  state.lied++;
  state.rel = clamp(state.rel - 14);
  state.press = clamp(state.press + 6);
  state.stress = clamp(state.stress + 8);
  addLog("You lied. Relationship drops hard. Stress rises.");
  state.slot = 0;
  state.ap = 3;
  aftermathStart();
}

function chooseSilent(){
  state.rel = clamp(state.rel - 8);
  state.press = clamp(state.press + 5);
  addLog("You said nothing. Silence creates distance.");
  state.slot = 0;
  state.ap = 3;
  aftermathStart();
}

/* ---------------------------
   AFTERMATH
---------------------------- */

async function aftermathStart(){
  await cutscene({
    title: "Aftermath",
    lines: [
      {speaker:"You", text:"The choice is made.", pauseAfterMs: 600},
      {speaker:"You", text:"Now you live with it.", pauseAfterMs: 800},
    ],
    onDoneLabel: "Continue",
    onDone: () => aftermathHub()
  });
}

function aftermathHub(){
  if(state.day > MAX_DAYS) return resolveEnding();

  setScreen(`
    <h2>Aftermath Phase — Day ${state.day}</h2>
    <p>Repair is possible. Not easy. You still get three staggered decisions per day.</p>

    <div class="grid2">
      <div class="card">
        <h3>Repair Trust</h3>
        <p class="muted">Harder if you lied or avoided earlier.</p>
        <div class="btns">
          <button ${state.ap<=0?"disabled":""} onclick="afterAction('apology')">Apologize + take responsibility</button>
          <button ${state.ap<=0?"disabled":""} onclick="afterAction('promises')">Make promises (risky)</button>
        </div>
      </div>

      <div class="card">
        <h3>Stabilize Life</h3>
        <p class="muted">Money and stress now determine stability.</p>
        <div class="btns">
          <button ${state.ap<=0?"disabled":""} onclick="afterAction('work')">Work extra shifts</button>
          <button ${state.ap<=0?"disabled":""} onclick="afterAction('routine')">Build routine at home</button>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <h3>Stress Relief</h3>
      <p class="muted">Still available. Still a tradeoff.</p>
      <div class="btns">
        <button ${state.ap<=0?"disabled":""} onclick="afterAction('walk')">Walk the block</button>
        <button ${state.ap<=0?"disabled":""} onclick="afterAction('bar')">One drink</button>
      </div>
    </div>

    <hr>
    <div class="btns">
      <button class="secondary" onclick="afterSkipSlot()">Skip this slot</button>
    </div>
  `);
}

async function afterAction(name){
  if(state.locked || state.ap <= 0) return;
  state.locked = true;

  // small beat
  await cutscene({
    title: "Moment",
    lines: [{speaker:"", text:"You try to keep moving forward…", pauseAfterMs: 600}],
    onDoneLabel: "Continue",
    onDone: () => {}
  });

  // apply
  useAP();
  if(name === "apology"){
    let delta = 10;
    if(state.lied > 0) delta = 6;
    if(state.rel < 25) delta = 4;
    state.rel = clamp(state.rel + delta);
    state.stress = clamp(state.stress + 2);
    addLog(`You apologized. Relationship +${delta}.`);
  }
  if(name === "promises"){
    const backfire = (state.money < 30) && chance(0.55);
    if(backfire){
      state.rel = clamp(state.rel - 8);
      state.stress = clamp(state.stress + 6);
      addLog("Promises feel hollow. Relationship drops.");
    } else {
      state.rel = clamp(state.rel + 5);
      addLog("Promises give a small lift—for now.");
    }
  }
  if(name === "work"){
    const gain = rint(7,13);
    state.money = clamp(state.money + gain);
    state.rel = clamp(state.rel - 3);
    state.stress = clamp(state.stress + 8);
    addLog(`Extra shifts: +${gain} money, but stress rises.`);
  }
  if(name === "routine"){
    state.stress = clamp(state.stress - 10);
    state.rel = clamp(state.rel + 3);
    addLog("You built routine and stability. Stress drops; trust inches up.");
  }
  if(name === "walk"){
    state.walked++;
    state.stress = clamp(state.stress - rint(10,16));
    state.press = clamp(state.press - 2);
    addLog("You walked. The world feels less sharp.");
  }
  if(name === "bar"){
    state.drank++;
    state.stress = clamp(state.stress - rint(14,22));
    state.money = clamp(state.money - rint(4,8));
    state.rel = clamp(state.rel - 2);
    state.press = clamp(state.press + 2);
    addLog("One drink takes the edge off. The bill still exists.");
  }

  state.locked = false;
  await afterEndSlotFlow(true);
}

async function afterSkipSlot(){
  if(state.locked) return;
  state.locked = true;
  state.stress = clamp(state.stress + 2);
  state.press = clamp(state.press + 2);
  addLog("You drift through the moment. It costs you.");
  state.ap = Math.max(0, state.ap - 1);
  state.locked = false;
  await afterEndSlotFlow(false);
}

async function afterEndSlotFlow(fromAction){
  // advance slot like before
  advanceSlot();

  if(state.slot === 0){
    // end of day drift after decision-phase days
    endOfDayDrift();
    // in aftermath, pressure resolves a bit faster
    state.press = clamp(state.press - 8);

    if(state.day > MAX_DAYS) return resolveEnding();
  }
  aftermathHub();
}

/* ---------------------------
   ENDING
---------------------------- */

function resolveEnding(){
  let stability = 50;
  stability += (state.rel - 50) * 0.7;
  stability += (state.money - 50) * 0.4;
  stability -= (state.stress - 40) * 0.6;
  stability -= (state.lied * 8);
  stability = clamp(Math.round(stability));

  let title = "";
  let ending = "";

  if(state.rel <= 22){
    title = "Custody Break";
    ending = "Your kid turns away. They choose to stay with their mother. The bond collapses under the week’s choices.";
  } else if(state.money <= 18){
    title = "Financial Collapse";
    ending = "You kept parts of your family intact, but money spirals. The stress becomes its own antagonist.";
  } else if(state.catOutcome === "moved_with_cats" && state.rel >= 55){
    title = "Hard Choice, Intact Bond";
    ending = "You moved and absorbed the cost. Trust holds because you prepared and stayed emotionally present.";
  } else if(state.catOutcome === "shelter" && state.truth > 0 && state.rel >= 45){
    title = "Truth With Consequences";
    ending = "You made a painful call, then owned it. The relationship strains but doesn’t break.";
  } else if(state.catOutcome === "system_removed"){
    title = "System Wins";
    ending = "You waited too long. The system resolved the problem for you, and the aftermath is colder than you expected.";
  } else {
    title = "Survival";
    ending = "You got through the week. The damage depends on what you prioritized—and what you avoided.";
  }

  const hooks = [
    (state.didMovePlan >= 3) ? "You explored moving seriously." : "You rarely looked for a new place.",
    (state.didHide > 0) ? "You used avoidance (hiding)." : "You avoided hiding tactics.",
    (state.didFriend) ? "You involved a friend." : "You never involved a friend.",
    (state.didShelter) ? "You contacted a shelter." : "You never contacted a shelter.",
    (state.drank > 0) ? `You drank (${state.drank}).` : "You didn’t drink.",
    (state.walked > 0) ? `You walked (${state.walked}).` : "You never took a walk.",
    (state.lied > 0) ? "You lied at least once." : "You never lied."
  ];

  setScreen(`
    <h2>Ending: ${escapeHtml(title)}</h2>
    <p>${escapeHtml(ending)}</p>

    <div class="grid2">
      <div class="card">
        <h3>Run Summary</h3>
        <p class="muted">
          Cat Outcome: <strong>${escapeHtml(String(state.catOutcome))}</strong><br>
          Stability Score: <strong>${stability}</strong><br>
          Truth/Lies: <strong>${state.truth}</strong> / <strong>${state.lied}</strong>
        </p>
        <p class="muted">${hooks.map(x => `• ${escapeHtml(x)}`).join("<br>")}</p>
      </div>
      <div class="card">
        <h3>Replay Goals</h3>
        <p class="muted">
          • Solve stress without the bar<br>
          • Never hide (no avoidance)<br>
          • Move early (search housing every day)<br>
          • Max relationship first, then solve money<br>
          • Let pressure get high and compare events
        </p>
      </div>
    </div>

    <div class="btns">
      <button onclick="resetRun(false); landlordIntroCutscene();">Replay</button>
      <button class="secondary" onclick="intro()">Back to start</button>
    </div>
  `);
}

/* ---------------------------
   RESET
---------------------------- */

function resetRun(silent){
  state.day = 1;
  state.slot = 0;
  state.ap = 3;

  state.money = 55;
  state.rel = 62;
  state.press = 10;
  state.stress = 18;
  state.cats = 65;

  state.didNegotiate = false;
  state.didTalk = 0;
  state.didOvertime = 0;
  state.didHide = 0;
  state.didFriend = false;
  state.didShelter = false;
  state.didMovePlan = 0;

  state.drank = 0;
  state.walked = 0;

  state.lied = 0;
  state.truth = 0;

  state.catOutcome = null;
  state.ending = null;
  state.locked = false;

  state.log = [];
  if(!silent) addLog("New run started.");
  renderHud();
}

// boot
resetRun(true);
intro();
</script>
</body>
</html>
